# .github/workflows/android-build.yml
name: ğŸ¤– Build Android APK

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Permet de dÃ©clencher manuellement

env:
  CARGO_TERM_COLOR: always

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ¦€ Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

    - name: â˜• Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸ¯ Install Android SDK & Tools
      run: |
        # Installation des outils Android
        sudo apt-get update
        sudo apt-get install -y wget unzip
        
        # Android SDK
        mkdir -p $HOME/android-sdk/cmdline-tools
        cd $HOME/android-sdk/cmdline-tools
        wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip commandlinetools-linux-9477386_latest.zip
        mv cmdline-tools latest
        
        # Variables d'environnement
        echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
        echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$HOME/android-sdk/platform-tools" >> $GITHUB_PATH

    - name: ğŸ”§ Install Android Components & NDK
      run: |
        yes | sdkmanager --licenses
        sdkmanager "platforms;android-33" "build-tools;33.0.2" "platform-tools" "ndk;25.2.9519653"
        
        # Configurer NDK
        echo "ANDROID_NDK_ROOT=$HOME/android-sdk/ndk/25.2.9519653" >> $GITHUB_ENV
        echo "ANDROID_NDK_HOME=$HOME/android-sdk/ndk/25.2.9519653" >> $GITHUB_ENV

    - name: ğŸš€ Install Cargo APK
      run: |
        cargo install cargo-apk
        
    - name: ğŸ“‹ Cache Cargo Dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: ğŸ” Debug NDK Setup
      run: |
        echo "ANDROID_NDK_ROOT: $ANDROID_NDK_ROOT"
        echo "ANDROID_HOME: $ANDROID_HOME"
        ls -la $ANDROID_HOME/ndk/ || echo "NDK directory not found"
        
    - name: ğŸ—ï¸ Build APK Debug
      run: |
        cargo apk build --target aarch64-linux-android
        
    - name: ğŸ—ï¸ Build APK Release
      run: |
        cargo apk build --release --target aarch64-linux-android

    - name: ğŸ“± List Generated APKs
      run: |
        find target -name "*.apk" -type f
        ls -la target/debug/apk/
        ls -la target/release/apk/ || true

    - name: ğŸ“¤ Upload Debug APK
      uses: actions/upload-artifact@v3
      with:
        name: chrono-sphere-debug-apk
        path: target/debug/apk/*.apk
        if-no-files-found: warn

    - name: ğŸ“¤ Upload Release APK
      uses: actions/upload-artifact@v3
      with:
        name: chrono-sphere-release-apk
        path: target/release/apk/*.apk
        if-no-files-found: warn

    - name: ğŸ“Š APK Info
      run: |
        if [ -f target/debug/apk/*.apk ]; then
          echo "ğŸ® APK Debug gÃ©nÃ©rÃ© avec succÃ¨s!"
          ls -lh target/debug/apk/*.apk
        fi
        if [ -f target/release/apk/*.apk ]; then
          echo "ğŸš€ APK Release gÃ©nÃ©rÃ© avec succÃ¨s!"
          ls -lh target/release/apk/*.apk
        fi
